<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualization - HMP Research</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1a344f',
                        secondary: '#ecc94b',
                        accent: '#0066cc'
                    },
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif'],
                    },
                }
            }
        }
    </script>

    <style type="text/tailwindcss">
        @layer utilities {
            .btn-active { @apply bg-accent text-white; }
            .btn-inactive { @apply bg-gray-100 text-gray-800 hover:bg-gray-200; }
            /* 让gif展示区更大：4:3 比 16:9 更高 */
            .aspect-4-3 { aspect-ratio: 4 / 3; }
        }
    </style>

    <style>
        body {
            padding-top: 80px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }
        #navbar {
            height: 80px;
            display: flex;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background-color: white;
            border-bottom: 1px solid #e5e7eb;
        }
        html { scroll-behavior: smooth; }

        .visualization-container { transition: all 0.3s ease; }

        .loader {
            border-top-color: #0066cc;
            animation: spinner 0.8s linear infinite;
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>

<body class="bg-white text-gray-800">
    <!-- 导航栏 -->
    <nav id="navbar" class="px-8">
        <div class="max-w-5xl mx-auto w-full flex justify-between items-center">
            <div class="text-xl font-medium text-primary">HMP Research</div>
            <div class="flex space-x-8">
                <a href="index.html" class="nav-link text-gray-700 hover:text-accent transition-colors">Home</a>
                <a href="downloads.html" class="nav-link text-gray-700 hover:text-accent transition-colors">Downloads</a>
                <a href="license.html" class="nav-link text-gray-700 hover:text-accent transition-colors">License</a>
                <a href="visualization.html" class="nav-link text-primary hover:text-accent transition-colors">Visualization</a>
                <a href="contact.html" class="nav-link text-gray-700 hover:text-accent transition-colors">Contact</a>
            </div>
        </div>
    </nav>

    <section class="bg-white">
        <div class="max-w-5xl mx-auto py-12 px-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-8 text-center">Interactive Visualization</h1>

            <div class="bg-white border border-gray-200 rounded-sm p-6 mb-8">
                <h2 class="text-2xl md:text-3xl font-bold text-gray-900 mb-6 text-center">Model & Dataset Selection</h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                    <!-- Ours（固定） -->
                    <div class="bg-gray-50 p-4 rounded-sm">
                        <h3 class="font-medium text-gray-900 mb-3 text-lg">Ours (Fixed)</h3>
                        <div class="flex items-center justify-between gap-4">
                            <div>
                                <p class="text-xl font-semibold text-primary">STCNet</p>
                                <p class="text-sm text-gray-600">Always shown on the left panel</p>
                            </div>
                            <span class="inline-flex items-center px-3 py-1 rounded-sm bg-accent text-white text-sm">
                                <i class="fas fa-lock mr-2"></i> Locked
                            </span>
                        </div>
                    </div>

                    <!-- Baseline -->
                    <div class="bg-gray-50 p-4 rounded-sm">
                        <h3 class="font-medium text-gray-900 mb-4 text-lg">Select Baseline Model</h3>
                        <div class="flex flex-wrap gap-3 mb-2">
                            <button id="baseline1" class="baseline-btn btn-active px-4 py-2 rounded-sm transition-colors" data-baseline="KSOF">
                                KSOF (Baseline)
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 数据集选择（初始不默认选中） -->
                <div class="bg-gray-50 p-4 rounded-sm mb-2">
                    <h3 class="font-medium text-gray-900 mb-4 text-lg">Select Dataset</h3>
                    <div class="flex flex-wrap gap-3 mb-2">
                        <button id="dataset1" class="dataset-btn btn-inactive px-4 py-2 rounded-sm transition-colors" data-dataset="Human3.6M">Human3.6M</button>
                        <button id="dataset2" class="dataset-btn btn-inactive px-4 py-2 rounded-sm transition-colors" data-dataset="AMASS">AMASS</button>
                        <button id="dataset3" class="dataset-btn btn-inactive px-4 py-2 rounded-sm transition-colors" data-dataset="3DPW">3DPW</button>
                    </div>
                </div>

                <p id="datasetWarning" class="hidden text-sm text-red-600 mt-2">
                    <i class="fas fa-exclamation-triangle mr-1"></i>
                    Please select a dataset before rendering.
                </p>

                <!-- 操作按钮 -->
                <div class="flex justify-center gap-4 my-8">
                    <button id="renderBtn" class="bg-accent text-white px-6 py-3 rounded-sm hover:bg-blue-700 transition-colors flex items-center">
                        <i class="fas fa-play mr-2"></i> Render Visualization
                    </button>
                    <button id="resetBtn" class="bg-gray-200 text-gray-800 px-6 py-3 rounded-sm hover:bg-gray-300 transition-colors flex items-center">
                        <i class="fas fa-refresh mr-2"></i> Reset
                    </button>
                </div>

                <!-- 可视化区域 -->
                <div id="visualizationArea" class="visualization-container border border-gray-200 rounded-sm overflow-hidden">
                    <!-- 空状态（默认显示） -->
                    <div id="emptyState" class="w-full aspect-4-3 bg-gray-50 flex flex-col items-center justify-center text-center px-6">
                        <div class="w-14 h-14 rounded-full bg-white border border-gray-200 flex items-center justify-center mb-4">
                            <i class="fas fa-image text-gray-400 text-2xl"></i>
                        </div>
                        <p class="text-gray-800 font-medium mb-1">No visualization yet</p>
                        <p class="text-gray-600 text-sm">
                            Select a dataset and click <span class="font-semibold">Render Visualization</span>.
                        </p>
                    </div>

                    <!-- 加载状态：每次 Render 固定 5 秒 -->
                    <div id="loadingState" class="hidden w-full aspect-4-3 bg-gray-50 flex flex-col items-center justify-center">
                        <div class="loader w-16 h-16 border-4 border-gray-200 rounded-full mb-4"></div>
                        <p class="text-gray-700">Rendering visualization... Please wait.</p>
                    </div>

                    <!-- 双 GIF（默认隐藏） -->
                    <div id="resultVisualization" class="hidden w-full bg-white">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-0">
                            <!-- 左：Ours -->
                            <div class="relative w-full aspect-4-3 bg-gray-100 border-b md:border-b-0 md:border-r border-gray-200">
                                <img
                                    id="oursGif"
                                    src=""
                                    alt="Ours GIF"
                                    class="w-full h-full object-cover cursor-pointer select-none"
                                    title="Click to replay"
                                >
                                <div id="oursOverlay" class="absolute top-4 left-4 bg-black/70 text-white px-3 py-1 rounded-sm text-sm">
                                    Ours: STCNet | -
                                </div>
                                <div class="absolute bottom-3 right-3 bg-black/60 text-white px-2 py-1 rounded-sm text-xs">
                                    Click to replay
                                </div>
                            </div>

                            <!-- 右：Baseline -->
                            <div class="relative w-full aspect-4-3 bg-gray-100">
                                <img
                                    id="baseGif"
                                    src=""
                                    alt="Baseline GIF"
                                    class="w-full h-full object-cover cursor-pointer select-none"
                                    title="Click to replay"
                                >
                                <div id="baseOverlay" class="absolute top-4 left-4 bg-black/70 text-white px-3 py-1 rounded-sm text-sm">
                                    Baseline: KSOF | -
                                </div>
                                <div class="absolute bottom-3 right-3 bg-black/60 text-white px-2 py-1 rounded-sm text-xs">
                                    Click to replay
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 指标区域：默认隐藏 -->
                <div id="metricsArea" class="hidden grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                    <div class="bg-white border border-gray-200 rounded-sm p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-lg font-semibold text-gray-900">Ours (STCNet) Metrics</h3>
                            <span class="text-sm text-gray-600">Dataset: <span id="oursDatasetTag">-</span></span>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-sm">
                            <h4 class="font-medium text-gray-900 mb-2">MPJPE (mm)</h4>
                            <p id="oursMpjpeValue" class="text-2xl font-bold text-accent">-</p>
                            <p class="text-sm text-gray-600">Lower is better</p>
                        </div>
                    </div>

                    <div class="bg-white border border-gray-200 rounded-sm p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-lg font-semibold text-gray-900">Baseline Metrics</h3>
                            <span class="text-sm text-gray-600"><span id="baseModelTag">KSOF</span> | <span id="baseDatasetTag">-</span></span>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-sm">
                            <h4 class="font-medium text-gray-900 mb-2">MPJPE (mm)</h4>
                            <p id="baseMpjpeValue" class="text-2xl font-bold text-accent">-</p>
                            <p class="text-sm text-gray-600">Lower is better</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="text-sm text-gray-600 flex flex-wrap gap-4 pt-4 border-t border-gray-200">
                <p>&copy; 2026 Anonymous Research Team - <a href="license.html" class="text-blue-600 hover:underline">Privacy Policy</a> - <a href="license.html" class="text-blue-600 hover:underline">License</a></p>
            </div>
        </div>
    </section>

    <script>
        // navbar shadow
        window.addEventListener('scroll', function() {
            const navbar = document.getElementById('navbar');
            if (window.scrollY > 50) navbar.classList.add('shadow-sm');
            else navbar.classList.remove('shadow-sm');
        });

        // ======= 状态：selected ≠ rendered（修复“点数据集立刻播放”的bug） =======
        const OURS_MODEL = "STCNet";

        let selectedBaseline = "KSOF";
        let selectedDataset  = null;

        let renderedBaseline = null;
        let renderedDataset  = null;

        let isRendering = false;

        // ======= 数据 =======
        const mpjpeData = {
            "STCNet": {
                "Human3.6M": 73.2,
                "AMASS": 52.1,
                "3DPW": 54.1
            },
            "KSOF": {
                "Human3.6M": 77.4,
                "AMASS": 59.2,
                "3DPW": 61.0
            }
        };

        const gifData = {
            "STCNet": {
                "Human3.6M": "./gifs/ours/Human3.6M.gif",
                "AMASS": "./gifs/ours/AMASS.gif",
                "3DPW": "./gifs/ours/3DPW.gif"
            },
            "KSOF": {
                "Human3.6M": "./gifs/baseline/KSOF/Human3.6M.gif",
                "AMASS": "./gifs/baseline/KSOF/AMASS.gif",
                "3DPW": "./gifs/baseline/KSOF/3DPW.gif"
            }
        };

        // ======= UI: baseline 选择（不触发展示更新） =======
        document.querySelectorAll('.baseline-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.baseline-btn').forEach(b => {
                    b.classList.remove('btn-active');
                    b.classList.add('btn-inactive');
                });
                this.classList.remove('btn-inactive');
                this.classList.add('btn-active');

                selectedBaseline = this.dataset.baseline;
                // 不更新GIF/指标（必须点 Render）
            });
        });

        // ======= UI: dataset 选择（不触发展示更新） =======
        document.querySelectorAll('.dataset-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.getElementById('datasetWarning').classList.add('hidden');

                document.querySelectorAll('.dataset-btn').forEach(b => {
                    b.classList.remove('btn-active');
                    b.classList.add('btn-inactive');
                });
                this.classList.remove('btn-inactive');
                this.classList.add('btn-active');

                selectedDataset = this.dataset.dataset;
                // 不更新GIF/指标（必须点 Render）
            });
        });

        // ======= Render：每次固定 5 秒 loading =======
        document.getElementById('renderBtn').addEventListener('click', function() {
            if (isRendering) return;

            if (!selectedDataset) {
                document.getElementById('datasetWarning').classList.remove('hidden');
                return;
            }

            isRendering = true;
            setRenderBtnDisabled(true);

            document.getElementById('datasetWarning').classList.add('hidden');

            // 进入 loading：隐藏空态/结果/指标
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('resultVisualization').classList.add('hidden');
            document.getElementById('metricsArea').classList.add('hidden');
            document.getElementById('loadingState').classList.remove('hidden');

            // 固定 5 秒
            setTimeout(() => {
                // commit 本次渲染的配置
                renderedDataset  = selectedDataset;
                renderedBaseline = selectedBaseline;

                // 显示结果
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('resultVisualization').classList.remove('hidden');
                document.getElementById('metricsArea').classList.remove('hidden');

                updateTagsAndOverlaysFromRendered();
                updateGifsFromRendered();
                updateMetricsFromRendered();

                isRendering = false;
                setRenderBtnDisabled(false);
            }, 5000);
        });

        // ======= Reset：回到完全空 =======
        document.getElementById('resetBtn').addEventListener('click', function() {
            isRendering = false;
            setRenderBtnDisabled(false);

            // baseline reset
            document.querySelectorAll('.baseline-btn').forEach(btn => {
                btn.classList.remove('btn-active');
                btn.classList.add('btn-inactive');
            });
            document.getElementById('baseline1').classList.remove('btn-inactive');
            document.getElementById('baseline1').classList.add('btn-active');
            selectedBaseline = "KSOF";

            // dataset reset：取消所有选中
            document.querySelectorAll('.dataset-btn').forEach(btn => {
                btn.classList.remove('btn-active');
                btn.classList.add('btn-inactive');
            });
            selectedDataset = null;

            // rendered 清空
            renderedBaseline = null;
            renderedDataset  = null;

            // UI回到空态
            document.getElementById('datasetWarning').classList.add('hidden');
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('resultVisualization').classList.add('hidden');
            document.getElementById('metricsArea').classList.add('hidden');
            document.getElementById('emptyState').classList.remove('hidden');

            // 清空gif src
            document.getElementById('oursGif').src = "";
            document.getElementById('baseGif').src = "";

            clearTagsAndOverlays();
            clearMetrics();
        });

        function setRenderBtnDisabled(disabled) {
            const btn = document.getElementById('renderBtn');
            btn.disabled = disabled;
            if (disabled) {
                btn.classList.add('opacity-60', 'cursor-not-allowed');
            } else {
                btn.classList.remove('opacity-60', 'cursor-not-allowed');
            }
        }

        // ======= 使用 rendered 状态更新（关键修复点） =======
        function updateTagsAndOverlaysFromRendered() {
            const dsText = renderedDataset ?? "-";
            const baseText = renderedBaseline ?? "KSOF";

            document.getElementById('oursDatasetTag').textContent = dsText;
            document.getElementById('baseModelTag').textContent = baseText;
            document.getElementById('baseDatasetTag').textContent = dsText;

            document.getElementById('oursOverlay').textContent = `Ours: ${OURS_MODEL} | ${dsText}`;
            document.getElementById('baseOverlay').textContent = `Baseline: ${baseText} | ${dsText}`;
        }

        function updateGifsFromRendered() {
            if (!renderedDataset || !renderedBaseline) return;

            const oursGif = document.getElementById('oursGif');
            const baseGif = document.getElementById('baseGif');

            const oursPath = gifData[OURS_MODEL]?.[renderedDataset];
            const basePath = gifData[renderedBaseline]?.[renderedDataset];

            const t = Date.now();
            oursGif.src = oursPath ? `${oursPath}?t=${t}` : "";
            baseGif.src = basePath ? `${basePath}?t=${t}` : "";

            if (!oursPath) console.warn(`Missing GIF path: gifData["${OURS_MODEL}"]["${renderedDataset}"]`);
            if (!basePath) console.warn(`Missing GIF path: gifData["${renderedBaseline}"]["${renderedDataset}"]`);
        }

        function updateMetricsFromRendered() {
            if (!renderedDataset || !renderedBaseline) return;

            const ours = mpjpeData[OURS_MODEL]?.[renderedDataset];
            const base = mpjpeData[renderedBaseline]?.[renderedDataset];

            document.getElementById('oursMpjpeValue').textContent = (ours ?? "-");
            document.getElementById('baseMpjpeValue').textContent = (base ?? "-");
        }

        // ======= 点击 GIF 重放（重放的是“当前渲染出的”gif） =======
        function replayGif(imgEl, path) {
            if (!path) return;
            const t = Date.now();
            imgEl.src = `${path}?t=${t}`;
        }

        document.getElementById('oursGif').addEventListener('click', () => {
            if (!renderedDataset) return;
            const path = gifData[OURS_MODEL]?.[renderedDataset];
            replayGif(document.getElementById('oursGif'), path);
        });

        document.getElementById('baseGif').addEventListener('click', () => {
            if (!renderedDataset || !renderedBaseline) return;
            const path = gifData[renderedBaseline]?.[renderedDataset];
            replayGif(document.getElementById('baseGif'), path);
        });

        function clearTagsAndOverlays() {
            document.getElementById('oursDatasetTag').textContent = "-";
            document.getElementById('baseModelTag').textContent = "KSOF";
            document.getElementById('baseDatasetTag').textContent = "-";
            document.getElementById('oursOverlay').textContent = `Ours: ${OURS_MODEL} | -`;
            document.getElementById('baseOverlay').textContent = `Baseline: KSOF | -`;
        }

        function clearMetrics() {
            document.getElementById('oursMpjpeValue').textContent = "-";
            document.getElementById('baseMpjpeValue').textContent = "-";
        }

        // 初始化：空态
        clearTagsAndOverlays();
        clearMetrics();
    </script>
</body>
</html>
